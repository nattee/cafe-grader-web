.row.my-2
  .col-md-5.mb-3
    .d-flex.flex-column.gap-1.mb-3
      %small.text-secondary.text-uppercase.fw-bold.ls-1 Management
      %h2.fw-bold.text-dark.mb-0 Problems

    .d-flex.flex-wrap.gap-2
      = link_to mdi(:add, 'me-1') + 'Import', {action: 'import'}, class: 'btn btn-sm btn-success'
      = link_to mdi(:settings, 'me-1') + 'Manage', { action: 'manage'}, class: 'btn btn-sm btn-outline-secondary'
      - if @current_user.admin?
        = link_to 'All Off', {action: 'turn_all_off'}, class: 'btn btn-sm btn-outline-secondary'
        = link_to 'All On', {action: 'turn_all_on'}, class: 'btn btn-sm btn-outline-secondary'
  .col-md-7.mb-3
    = render partial: 'problem_help'

.card.card-shadow
  .card-body

    %table#main_table.table.table-condense.table-hover{'data-controller': 'init-ui-component'}
      %thead
        %tr
          %th Name
          %th Full name
          %th Difficulty
          %th.text-end
            A - D(T)
            = render partial: 'tooltip', locals: {title: 'number of attachments, datasets, testcases of the problem'}
          %th.text-end Solution/Hint
          %th Tags
          %th
            Submit
            = render partial: 'tooltip', locals: {title: 'Admin can always submit to any problem'}
          %th Date added
          %th.text-center
            Avail?
            = render partial: 'tooltip', locals: {title: 'If "Avail?" is not set, the problem will remain hidden from all contestants, even if enabled in groups or contests.'}
          %th.text-center
            View Testcase?
            = render partial: 'tooltip', locals: {title: 'Let user view the testcase of this problem?'}
          %th.text-center
          %th.text-center
          %th.text-center
      %tbody
        - for problem in @problems
          %tr{:class => "#{(problem.available) ? "table-success" : ""}", :id => "prob-#{problem.id}", :name => "prob-#{problem.id}"}
            - @problem=problem
            %td= problem.name
            %td
              = problem.full_name
              = link_to_description_if_any "[<span class='mi md-18'>description</span> Read]".html_safe, problem, class: "link-flex"
              = link_to "[<span class='mi md-18'>archive</span> Files]".html_safe, download_by_type_problem_path(problem,'attachment'), class: 'link-flex' if problem.attachment.attached?
            %td= render_star(problem.difficulty)
            %td.text-end
              = problem.live_dataset.checker.attached? ? mdi(:checkbook) : ''
              = "#{problem.attachment.attached? ? 1 : 0} - #{problem.dataset_count}(#{problem.tc_count})"
            %td.text-end= "#{problem.ms_count || '-'}/#{problem.hint_count || '-'}"
            %td
              - problem.tags.each do |t|
                %span.badge.text-bg-secondary.bg-opacity-100= t.name
            %td.py-1.align-middle= link_to "Submit", direct_edit_problem_submissions_path(problem,@current_user.id), class: 'btn btn-sm btn-primary'
            %td= problem.date_added
            %td
              .form-check.form-switch.d-flex.justify-content-center
                %input.form-check-input{id: "prob-#{problem.id}-available-switch", checked: problem.available, type: "checkbox", data: {action: 'problem#toggle', 'row-id': problem.id, field: 'available', readonly: @current_user.admin? ? 'false' : 'true'}, disabled: @current_user.admin? == false}
            %td 
              -#= toggle_button(@problem.view_testcase?, toggle_view_testcase_problem_path(@problem), "problem-view-testcase-#{@problem.id}")
              .form-check.form-switch.d-flex.justify-content-center
                %input.form-check-input{id: "prob-#{problem.id}-view-testcase-switch", checked: problem.view_testcase, type: "checkbox", data: {action: 'problem#toggle', 'row-id': problem.id, field: 'view_testcase'}}
            %td= link_to "#{mdi(:finance)}Stat".html_safe, {:action => 'stat', :id => problem.id}
            %td= link_to 'Edit', {:action => 'edit', :id => problem}
            %td.py-1.align-middle= link_to 'Destroy', { :action => 'destroy', :id => problem }, 'data-confirm': 'Are you sure?', :method => :delete, class: 'btn btn-danger btn-sm btn-block py-1'
    %br

-# hidden form for problem toggle
= form_with url: toggle_view_testcase_problem_path(-123), html: {data: {turbo: true, 'problem-target': 'toggleViewTestcaseForm', action: 'turbo:submit-end->problem#resetToggleForm'}} do
  /
= form_with url: toggle_available_problem_path(-123), html: {data: {turbo: true, 'problem-target': 'toggleAvailableForm', action: 'turbo:submit-end->problem#resetToggleForm'}} do
  /

:javascript
  function init_table() {
    $("#main_table").DataTable({
      sorting: false,
      columnDefs: [
        { targets: [3,4,5,6,10,11,12], sortable: false },
      ],
      paging: false,
      responsive: true,
      dom: "<'row'<'#prob-group.col-sm-12 col-md-6'l><'col-sm-12 col-md-6'f>>" +
        "<'row'<'col-sm-12'tr>>" +
        "<'row'<'col-sm-12 col-md-5'i><'col-sm-12 col-md-7'p>>",
    })
  }

  // this function is called by the 
  function set_problem_switch(problem_id,available,view_testcase) {
    let avail_button = document.getElementById(`prob-${problem_id}-available-switch`)
    avail_button.checked = available
    avail_button.disabled = avail_button.dataset.readonly == 'true'

    row = document.getElementById(`prob-${problem_id}`)
    if (available) { row.classList.add('table-success')} else { row.classList.remove('table-success')}

    let view_testcase_button = document.getElementById(`prob-${problem_id}-view-testcase-switch`)
    view_testcase_button.checked = view_testcase
    view_testcase_button.disabled = false
  }

  window.addEventListener("load", function() {
    init_table();
  });

